# Backend Test Task

<<<<<<< HEAD
ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð´Ð°Ð½Ð¸Ñ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² [TASK.md](./TASK.md).

## Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
=======
?????? ?????????? ??????? ????????? ? [TASK.md](./TASK.md).

## ??????? ?????
>>>>>>> cdb9d26 (done)

```bash
docker compose up --build
```

API: `http://localhost:3000`

<<<<<<< HEAD
## ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
=======
## ???????? ???????
>>>>>>> cdb9d26 (done)

```bash
docker compose exec api npm run migrate
docker compose exec api npm test
docker compose down -v
```

<<<<<<< HEAD
## Ð§Ñ‚Ð¾ ÑÐ´Ð°Ð²Ð°Ñ‚ÑŒ

- ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¸Ð»Ð¸ Ð²ÐµÑ‚ÐºÑƒ Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸;
- Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ `README.md` Ñ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð¼ `ÐÐ½Ð°Ð»Ð¸Ð· Ð¸ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³` (Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð½Ð° 7 Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸Ð· `TASK.md`);
- Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð² Ð¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚.
=======
## ?????? ??????

????? ??????????? ????? ????????:

```bash
npm test
```

??? ?????????? ??????? ????? ????????? PostgreSQL ? Redis (??? ?????? ????? `docker compose exec api npm test`).

???????????? ????????, ???????? ???????????:
- duplicate request ??? `POST /users/:id/spend` ?? ??????? ????????? ????????;
- expired accrual ?? ????????? ? ????????? ???????;
- ???????????? ???????? ?? ???????? ? ??????????? ???????;
- ????????? ??????????/????????? ????????? `expire-accruals` ?? ??????? ?????? ??????-???????.

## ?????? ? ???????????

### 1) ????? ???????? ???? ? ???????? ?????????? ?????????
- ?????? ???????? ?????? ?? `accrual`, ??? ????? `spend` ? ????? ???????? ??????????.
- ?? ???? ?????????? ? ?????? ?? ?????, ??????? ???????????? ???????? ????? ??????? ???? ? ??? ?? ??????.
- ?? ???? ???????????????: ?????? ??????????? ??????? ???????? ????????? ????????.
- ???????? `requestId` ?? ?????????????.

### 2) ????? ???????? ??? ????????????? ???????? ?? ????????? ? ??? ???????
- ???????? ?????????? ? ???? ??-??????????.
- ????????? ???????????? ???????? ?? ???????????? ????? `pg_advisory_xact_lock(hashtext(userId))`.
- ???????? ????????????? `(user_id, request_id)` ? ?????? ??????? ??????????? ?????? ??? ?? ??????????.
- ? ?????????? ???????????? ??????? ?? ????? ???????????? ??????? ?????? ??????????.

### 3) ????? ???????????? ??????? ???????????? ?? ?????????? ?? ?????? ?? ? ?? ?????? ?????
?? ?????? ??:
- ???????? ?????????? ?????? `bonus_transactions_user_request_spend_uq` ?? `(user_id, request_id)` ??? `type='spend'` ? `request_id IS NOT NULL`;
- ????? ?????????? ???????????? `request_id`, ????? ??????? ??????????????? ???? ?? ????????????.

?? ?????? ????:
- ????????? `amount` ? ????????????? `requestId`;
- ????????? `Idempotency-Key` ??? `body.requestId`;
- ??????? `409`, ???? `requestId` ??? ??????????? ??? ?? ?????????????, ?? ? ?????? payload (`amount`);
- ??????? `400` ??? ????????????? ???????.

### 4) ??? ??????????? ?????? ?? ?????????? ??????????? ??????? (duplicate request)?
- ????????????? ??????? ??????? ?? `Idempotency-Key` ??? `body.requestId`.
- ????? ????????? ?????? ???????????? `spend` ? ??? ?? `(user_id, request_id)`.
- ???? ?????? ? payload ?????????, ???????????? `200 { success: true, duplicated: true }` ??? ????? ?????????? ????????.
- ???? payload ??????????, ???????????? `409`.

### 5) ??? ??????????, ??? ???????????? ?????????? (expired accrual) ?? ????????? ? ????????
- ? ??????? ?????????? ??????? ??????????? ?????? `accrual` ? `expires_at IS NULL OR expires_at >= NOW()`.
- `accrual` ? ???????? ?????? ??????????? ?? ????????? ???????.

### 6) ??? ??????????? ???????? ????????? ??????? (????????? ???????, ?????, ?????? ?? ??????)?
- `POST /jobs/expire-accruals` ?????? ?????? ? ????????????? `jobId: "expire-accruals"`.
- ??? job ????????? `attempts: 3` ? `backoff` c ????????? `1000ms`.
- Worker ???????????? `expireAccruals`: ??? ??????? ????????????? ?????????? ??????? `spend` ?? ?? ?? ????? ? `request_id = "expire:<accrual_id>"`.
- ??????? ???? ????? `INSERT ... ON CONFLICT DO NOTHING` ?? `(user_id, request_id)`, ??????? ????????? ????????? ?? ???? ??????.

### 7) ????? ??????????? ?? ??????? ? ?????? ??????????? 4–6 ??????
- ??????? ???????? ????????? ?????? ???????????? ??????????? (??? ??????? ??-???????).
- ???????????? ?????? ??????????? ????? advisory lock ?? ???????????? ?????? ????? ??????? ???? ?????????????? ???????????.
- ????? ??????? ??????????????? ?? ????????? ????? ?? ???????, ??? ?????????? ???????? ?? ?????????????? ????????.
>>>>>>> cdb9d26 (done)
